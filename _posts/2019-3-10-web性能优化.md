---
title: web 新能优化
tags:
  - 性能
  - 优化
---

从网页开始请求到加载完成，从前端角度分析如何实现 web 性能优化，即：网页加载更快。

<!-- more -->

网页开始请求到加载完成可分为以下几个过程：

1. 本地缓存 `×` 第一次访问没有缓存 
2. DNS 缓存 `√`
3. 建立 TCP 连接 `√` 
4. 发送请求 `√`
5. 后台处理 `×` 前端无法处理
6. 接收响应 `√`
7. 接收完成 `√`
8. 解读DOCTYPE `√`
9. 逐行解析 `√`
10. 解析标签 `√`
11. 解析 CSS `√`
12. 解析 JS `√`

# DNS 缓存

网页中的域名需要经过域名解析，而一次解析就要20-120 ms 的时间。在dns查询结束之前，浏览器不会下载该域名下的任何东西。所以减少dns查询的时间可以加快页面的加载速度。建议一个页面所包含的域名数尽量控制在2-4个。

# 建立 TCP 连接

Keep-Alive 是一个通用消息头，允许消息发送者暗示连接的状态，还可以用来设置超时时长和最大请求数。

建立TCP连接首先需要三次握手，在传输数据之前，在客户端和服务器之间相互交换SYN和ACK数据包。使用keep-alive标头意味着不必经常执行此过程。好处有：

- 网络资源保护：每个客户端使用单个连接对网络资源的负担较小。
- 减少网络拥塞：减少服务器和客户端之间的TCP连接数可能会导致网络拥塞减少。
- 减少延迟：减少三方握手次数可以改善网站延迟。对于SSL / TLS连接尤其如此，这需要额外的往返来加密和验证连接。

HTTP/2 中使用的是多路复用。

HTTP 1.x 中，如果想并发多个请求，必须使用多个 TCP 链接，且浏览器为了控制资源，还会对单个域名有 6-8个的TCP链接请求限制。

在 HTTP/2中：

同域名下所有通信都在单个连接上完成。单个连接可以承载任意数量的双向数据流。数据流以消息的形式发送，而消息又由一个或多个帧组成，多个帧之间可以乱序发送，因为根据帧首部的流标识可以重新组装。

这一特性，使性能有了极大提升：

同个域名只需要占用一个 TCP 连接，消除了因多个 TCP 连接而带来的延时和内存消耗。
单个连接上可以并行交错的请求和响应，之间互不干扰。
在HTTP/2中，每个请求都可以带一个31bit的优先值，0表示最高优先级， 数值越大优先级越低。有了这个优先值，客户端和服务器就可以在处理不同的流时采取不同的策略，以最优的方式发送流、消息和帧。

# 发送请求

因为浏览器每次发送请求都会带上 cookie ，因此减少 cookie 的大小可以加快请求速度。并使用cache-control。倘若文件过大，就分多次请求，避免用户一次等待过多时间。这是就需要多个域名，增大瞬间请求的数量。

# 接收响应

1. 使用 Etag，倘若服务器内容未更新，则服务器返回304.
2. 使用 Gzip 压缩。服务器把响应内容压缩后再传输，浏览器重新解压后再使用数据。 

# doctype

doctype 写错可能导致页面显示不正常，并且不能不写。

# 逐行解析

尽量减少标签数量

# 解析标签

解析到标签，比如`h1`

在 ie 中会直接显示便签，在解析到 CSS 后再重新渲染标签，影响性能

在 Chrome 中，浏览器默认用户是在网速很快的环境下的，因此是等到 css 加载完毕再显示标签

# 解析 CSS

1. 尽量少的 CSS 以减少请求数量。
2. 将 CSS 放到页面首部，某些浏览器就不用重载页面。
3. 压缩文件大小

# 解析 js

1. js脚本文件放到页面底部，因为脚本文件会阻塞页面加载
2. 尽量减少的 js 以减少请求数量。
3. 压缩文件大小。
4. 懒加载，先加载用户时候的数据，当用户滚动的时候再加载下面的。
5. 加 loading 动画可以延长用户等待时间。
6. 将 js 和 CSS 文件放到CDN上，速度快，而且都是无cookie请求。

> 引用
- [Keep-Alive](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Keep-Alive)
- [What is HTTP Keep-Alive](https://www.incapsula.com/cdn-guide/glossary/http-keep-alive.html)
- [一文读懂 HTTP/2 特性](https://zhuanlan.zhihu.com/p/26559480)
- []()